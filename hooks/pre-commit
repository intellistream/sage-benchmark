#!/bin/bash
# Pre-commit hook for sage-benchmark
# Runs code quality checks before allowing commit

set -e

echo "üîç Running pre-commit checks..."

# Check if ruff is installed
if ! command -v ruff &> /dev/null; then
    echo "‚ö†Ô∏è  ruff not found, skipping format check"
else
    # Only operate on staged Python files to avoid accidentally staging unstaged changes
    STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

    if [ -n "$STAGED_PY" ]; then
        echo "üìù Auto-fixing code formatting on staged files..."
        echo "$STAGED_PY" | xargs ruff format
        echo "‚úÖ Code formatting done"

        echo "üîç Auto-fixing lint issues on staged files..."
        echo "$STAGED_PY" | xargs ruff check --fix || true

        # Re-stage only the files we auto-fixed
        echo "$STAGED_PY" | xargs git add

        # Final check ‚Äì fail if unfixable issues remain
        echo "üîç Final lint check (unfixable issues)..."
        if ! echo "$STAGED_PY" | xargs ruff check; then
            echo "‚ùå Unfixable lint issues remain. Please fix them manually."
            exit 1
        fi
        echo "‚úÖ Lint check passed"
    else
        echo "‚ÑπÔ∏è  No staged Python files to check"
    fi
fi

# Check for common issues
echo "üîç Checking for common issues..."

# Check for hardcoded API keys in staged Python files only
if git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | xargs grep -l "api[_-]key\s*=\s*['\"]sk-" 2>/dev/null; then
    echo "‚ùå Hardcoded API keys detected!"
    exit 1
fi

# Check for debug statements in staged Python files only
if git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | xargs grep -l "import pdb\|breakpoint()" 2>/dev/null; then
    echo "‚ö†Ô∏è  Debug statements detected (pdb/breakpoint) in staged Python files"
    echo "Remove them or use --no-verify to skip this check"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
