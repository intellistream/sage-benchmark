name: Upload to Hugging Face

# 当 hf_data/ 下有 JSON 文件变动时自动触发（仅 main-dev 分支）
# 用户工作流：
#   1. python scripts/aggregate_for_hf.py   （本地聚合）
#   2. git add hf_data/ && git commit && git push origin main-dev  （触发此 workflow）
#   3. Actions 自动：并发安全合并 → 上传 HF → 清理 hf_data/
#
# 注意：main 分支不触发此 workflow，benchmark results 不应直接推送到 main。

on:
  push:
    branches:
      - main-dev
    paths:
      - "hf_data/**/*.json"

jobs:
  upload-to-hf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install huggingface_hub

      # 关键步骤：并发安全合并（再次从 HF 拉取最新，解决多用户并发冲突）
      - name: Merge with latest HF data (conflict resolution)
        env:
          HF_REPO: intellistream/sage-benchmark-results
        run: |
          python scripts/merge_and_upload.py

      # 上传到 Hugging Face
      - name: Upload to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_ENDPOINT: https://hf-mirror.com
        run: |
          python scripts/upload_to_hf.py

      # 上传成功后清理 hf_data/，保持仓库轻量
      - name: Clean up hf_data (keep repo lean)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git rm -rf hf_data/ || true
          git diff --cached --quiet || git commit -m "chore: clean up hf_data after HF upload [skip ci]"
          git push || true
